- name: "Site [{{ i }} = {{ target_domain }}]: Server [{{ j }} = {{ server }}]: Syncing"
  shell: "rsync -arvKe \"ssh -o StrictHostKeyChecking=no\" --chown 0:0 {{ webserver_root_content }}/{{ target_domain }} root@{{ server }}:{{ target_webserver_root_path }}"
  delegate_to: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"

- name: "Site [{{ i }} = {{ target_domain }}]: Server [{{ j }} = {{ server }}]: Building webserver configuration"
  template:
    src: "{{ webserver_conf_template_path }}/{{ webserver_app }}.j2"
    dest: "{{ webserver_conf_template_path }}/{{ target_domain }}"
  delegate_to: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"

- name: "Site [{{ i }} = {{ target_domain }}]: Server [{{ j }} = {{ server }}]: Replacing webserver configuration"
  shell: "rsync -avKe \"ssh -o StrictHostKeyChecking=no\" --chown 0:0 {{ webserver_conf_template_path }}/{{ target_domain }} root@{{ server }}:{{ target_webserver_conf_path }}/{{ target_domain }}"
  delegate_to: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"

- name: "Site [{{ i }} = {{ target_domain }}]: Server [{{ j }} = {{ server }}]: Deleting webserver configuration buffer"
  file:
    state: absent
    path: "{{ webserver_conf_template_path }}/{{ target_domain }}"
  delegate_to: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"

- name: "Site [{{ i }} = {{ target_domain }}]: Server [{{ j }} = {{ server }}]: Reloading webserver"
  shell: "ssh -o StrictHostKeyChecking=no root@{{ server }} {{ target_reload_command }}"
